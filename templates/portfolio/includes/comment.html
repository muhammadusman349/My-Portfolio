{% load static %}

{% if comment.status == 'approved' %}
<div id="comment-{{ comment.id }}"
     class="comment-container group relative bg-white dark:bg-gray-800 rounded-lg shadow-sm p-3 sm:p-4 mb-4 sm:mb-5 transform transition-all duration-300 hover:shadow-md {% if comment.parent %}ml-0 sm:ml-8{% endif %}"
     data-nesting-level="{{ comment.get_nesting_level }}">
    <div class="flex items-start space-x-3 sm:space-x-4">
        <!-- User Avatar -->
        <div class="flex-shrink-0">
            <img class="h-10 w-10 rounded-full object-cover"
                 src="{{ comment.user.profile_picture.url }}"
                 alt="{{ comment.user.first_name }} {{ comment.user.last_name }}">
        </div>

        <!-- Comment Content -->
        <div class="flex-grow space-y-2 md:space-y-3">
            <!-- Comment Header -->
            <div class="flex flex-col sm:flex-row items-start justify-between w-full">
                <div class="flex-shrink-0">
                    <h4 class="text-sm md:text-base font-medium text-gray-900 dark:text-white">
                        {% if comment.user.get_full_name %}
                            {{ comment.user.get_full_name }}
                        {% else %}
                            {{ comment.user.username }}
                        {% endif %}
                        {% if comment.is_owner_reply %}
                            <span class="ml-2 px-2 py-0.5 text-xs bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded-full">
                                Owner
                            </span>
                        {% endif %}
                    </h4>
                    <p class="text-xs sm:text-sm text-gray-500 dark:text-gray-400">
                        {{ comment.created_at|timesince }} ago
                        {% if comment.is_edited %}
                            · Edited
                        {% endif %}
                        {% if comment.parent %}
                            · Replying to {{ comment.parent.user.username }}
                        {% endif %}
                    </p>
                </div>

                <!-- Comment Actions: inline toolbar (backend forms, no JS) -->
                <div class="mt-0 flex flex-wrap items-center gap-2">
                    {% if user.is_authenticated %}
                        <!-- Like Form (HTMX: in-place swap) -->
                        <form method="post" action="{% url 'portfolio:toggle_like' comment.id %}"
                              hx-post="{% url 'portfolio:toggle_like' comment.id %}"
                              hx-target="#comment-{{ comment.id }}" hx-swap="outerHTML">
                            {% csrf_token %}
                            <button type="submit"
                                    class="action-button like-btn inline-flex items-center px-2 py-1 text-xs font-medium rounded-md transition-colors duration-200 {% if user in comment.likes.all %}text-blue-600 bg-blue-50 hover:bg-blue-100 dark:text-blue-400 dark:bg-blue-900/50 dark:hover:bg-blue-900/70{% else %}text-gray-500 hover:text-blue-600 hover:bg-blue-50 dark:text-gray-400 dark:hover:text-blue-400 dark:hover:bg-blue-900/50{% endif %}">
                                <svg class="w-4 h-4 {% if user in comment.likes.all %}text-blue-600 dark:text-blue-400{% endif %}"
                                     fill="{% if user in comment.likes.all %}currentColor{% else %}none{% endif %}"
                                     stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/>
                                </svg>
                                <span class="label ml-1.5">{{ comment.get_like_count }}</span>
                            </button>
                        </form>

                        {% if comment.status == 'approved' %}
                        <!-- Reply Button (show reply panel, hide edit panel and other forms) -->
                        <button type="button" class="action-button inline-flex items-center px-2 py-1 text-xs font-medium rounded-md text-gray-500 hover:text-blue-600 hover:bg-blue-50 dark:text-gray-400 dark:hover:text-blue-400 dark:hover:bg-blue-900/50 transition-colors duration-200"
                                hx-on:click="closeAllCommentForms(); const c=this.closest('.comment-container'); if(!c) return; const r=c.querySelector('.reply-panel'); if(r) r.classList.remove('hidden');">
                          Reply
                        </button>
                        {% endif %}

                        {% if user == comment.user %}
                        <!-- Edit Button (show edit panel, hide reply panel and other forms) -->
                        <button type="button" class="action-button inline-flex items-center px-2 py-1 text-xs font-medium rounded-md text-gray-500 hover:text-green-600 hover:bg-green-50 dark:text-gray-400 dark:hover:text-green-400 dark:hover:bg-green-900/50 transition-colors duration-200"
                                hx-on:click="closeAllCommentForms(); const c=this.closest('.comment-container'); if(!c) return; const e=c.querySelector('.edit-panel'); if(e) e.classList.remove('hidden');">
                          Edit
                        </button>

                        <!-- Delete trigger opens modal and closes reply/edit panels if open -->
                        <button type="button" class="action-button inline-flex items-center px-2 py-1 text-xs font-medium rounded-md text-gray-500 hover:text-red-600 hover:bg-red-50 dark:text-gray-400 dark:hover:text-red-400 dark:hover:bg-red-900/50 transition-colors duration-200"
                                hx-on:click="const c=this.closest('.comment-container'); if(c){c.querySelector('.reply-panel')?.classList.add('hidden'); c.querySelector('.edit-panel')?.classList.add('hidden');} const m=document.getElementById('confirm-delete-{{ comment.id }}'); if(m) m.classList.remove('hidden');">
                          Delete
                        </button>

                        <!-- Small confirmation modal (anchor-based open/close) -->
                        <div id="confirm-delete-{{ comment.id }}" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center hidden"
                             hx-on:htmx:afterSwap="window.location.hash='';">
                          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 w-full max-w-sm mx-2">
                            <div class="text-sm text-gray-700 dark:text-gray-200">Delete this comment?</div>
                            <div class="mt-4 flex justify-end gap-2">
                              <button type="button" class="px-3 py-1.5 text-xs rounded-md border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700" hx-on:click="this.closest('#confirm-delete-{{ comment.id }}').classList.add('hidden');">Cancel</button>
                              <form method="post" action="{% url 'portfolio:delete_comment' comment.id %}"
                                    hx-post="{% url 'portfolio:delete_comment' comment.id %}"
                                    hx-target="#comment-{{ comment.id }}" hx-swap="outerHTML">
                                {% csrf_token %}
                                <button type="submit" class="px-3 py-1.5 text-xs rounded-md bg-red-600 text-white hover:bg-red-700">Delete</button>
                              </form>
                            </div>
                          </div>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>

            <!-- Comment Text -->
            <div class="prose prose-sm max-w-none text-gray-900 dark:text-gray-300">
                {{ comment.text|linebreaks }}
            </div>

            <!-- Panels wrapper controlled via small HTMX inline JS for toggling -->
            <div class="panels-{{ comment.id }} mt-3">
              <!-- Reply Panel -->
              <div class="reply-panel hidden">
                <form action="{% url 'portfolio:add_comment' project.id %}" method="post"
                      class="space-y-3 max-w-[600px] w-full"
                      hx-post="{% url 'portfolio:add_comment' project.id %}"
                      hx-target="#comment-{{ comment.id }}" hx-swap="outerHTML">
                  {% csrf_token %}
                  <input type="hidden" name="parent_id" value="{{ comment.id }}">
                  <div>
                    <label for="reply-text-{{ comment.id }}" class="sr-only">Reply to comment</label>
                    <textarea id="reply-text-{{ comment.id }}" name="text" rows="3" class="w-full p-2 sm:p-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 bg-gray-100 dark:bg-gray-700 dark:text-white placeholder-gray-400 shadow-inner resize-none" placeholder="Write your reply..." required></textarea>
                  </div>
                  <div class="flex justify-end gap-2">
                    <button type="button" class="px-2.5 py-1.5 sm:px-3 text-xs sm:text-sm text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" hx-on:click="const c=this.closest('.comment-container'); if(!c) return; c.querySelector('.reply-panel')?.classList.add('hidden');">Close</button>
                    <button type="submit" class="px-2.5 py-1.5 sm:px-3 text-xs sm:text-sm text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">Post Reply</button>
                  </div>
                </form>
              </div>

              {% if user == comment.user %}
              <!-- Edit Panel -->
              <div class="edit-panel hidden">
                <form action="{% url 'portfolio:edit_comment' comment.id %}" method="post"
                      class="space-y-3 max-w-[600px] w-full"
                      hx-post="{% url 'portfolio:edit_comment' comment.id %}"
                      hx-target="#comment-{{ comment.id }}" hx-swap="outerHTML">
                  {% csrf_token %}
                  <div>
                    <label for="edit-text-{{ comment.id }}" class="sr-only">Edit comment</label>
                    <textarea id="edit-text-{{ comment.id }}" name="text" rows="3" class="w-full p-2 sm:p-2.5 text-sm border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-green-500 bg-gray-100 dark:bg-gray-700 dark:text-white placeholder-gray-400 shadow-inner resize-none" required>{{ comment.text }}</textarea>
                  </div>
                  <div class="flex justify-end gap-2">
                    <button type="button" class="px-2.5 py-1.5 sm:px-3 text-xs sm:text-sm text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" hx-on:click="const c=this.closest('.comment-container'); if(!c) return; c.querySelector('.edit-panel')?.classList.add('hidden');">Close</button>
                    <button type="submit" class="px-2.5 py-1.5 sm:px-3 text-xs sm:text-sm text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">Save Changes</button>
                  </div>
                </form>
              </div>
              {% endif %}
            </div>
        </div>
    </div>

    <!-- Nested Replies with Thread Line -->
    {% with replies=comment.get_replies %}
    {% if replies %}
    <div class="relative">
        <!-- Thread Line -->
        <div class="absolute left-5 sm:left-6 top-0 bottom-0 w-px bg-gray-200 dark:bg-gray-700"></div>
        <div id="replies-{{ comment.id }}" class="mt-4 space-y-4 relative">
            {% for reply in replies %}
                {% if reply.status == 'approved' %}
                    {% include "portfolio/includes/comment.html" with comment=reply %}
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% endwith %}
</div>
{% endif %}
